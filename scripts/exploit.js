// 1ï¸âƒ£ Importamos Hardhat
const { ethers } = require("hardhat");

// 2ï¸âƒ£ FunciÃ³n principal autoejecutable
async function main() {
    // 3ï¸âƒ£ Obtenemos las cuentas del nodo Hardhat
    const [deployer, attacker] = await ethers.getSigners();
    console.log(`âœ… Deployer: ${deployer.address}`);
    console.log(`âœ… Attacker: ${attacker.address}`);

    // 4ï¸âƒ£ Desplegamos el contrato vulnerable
    const VulnerableContract = await ethers.getContractFactory("VulnerableContract");
    const vulnerable = await VulnerableContract.deploy();
    await vulnerable.waitForDeployment();
    console.log(`ðŸ“Œ Contrato vulnerable desplegado en: ${await vulnerable.getAddress()}`);

    // 5ï¸âƒ£ Hacemos un depÃ³sito inicial en el contrato vulnerable
    let tx = await vulnerable.connect(deployer).deposit({ value: ethers.parseEther("10") });
    await tx.wait();
    console.log(`âœ… Se depositaron 10 ETH en el contrato vulnerable`);

    // 6ï¸âƒ£ Desplegamos el contrato atacante, pasÃ¡ndole la direcciÃ³n del contrato vulnerable
    const Attack = await ethers.getContractFactory("Attack");
    const attack = await Attack.connect(attacker).deploy(await vulnerable.getAddress());
    await attack.waitForDeployment();
    console.log(`ðŸ“Œ Contrato atacante desplegado en: ${await attack.getAddress()}`);

    // 7ï¸âƒ£ Verificamos el balance inicial del atacante
    let attackerBalance = await ethers.provider.getBalance(attacker.address);
    console.log(`ðŸ”¹ Balance inicial del atacante: ${ethers.formatEther(attackerBalance)} ETH`);

    // 8ï¸âƒ£ Ejecutamos el ataque enviando 1 ETH al contrato atacante
    tx = await attack.connect(attacker).attack({ value: ethers.parseEther("1") });
    await tx.wait();
    console.log(`ðŸš¨ Â¡Ataque ejecutado! ðŸš¨`);

    let balanceAntes = await ethers.provider.getBalance(vulnerable.target);
    console.log("ðŸ’° Balance del contrato vulnerable antes del ataque:", ethers.formatEther(balanceAntes));

    let balanceDespues = await ethers.provider.getBalance(vulnerable.target);
    console.log("ðŸ’€ Balance del contrato vulnerable despuÃ©s del ataque:", ethers.formatEther(balanceDespues));


    // 9ï¸âƒ£ Verificamos el balance final del atacante
    attackerBalance = await ethers.provider.getBalance(attacker.address);
    console.log(`ðŸ”¹ Balance final del atacante: ${ethers.formatEther(attackerBalance)} ETH`);
}

//  ðŸ”Ÿ Ejecutamos la funciÃ³n main y capturamos errores
main().catch((error) => {
    console.error(error);
    process.exitCode = 1;
});
